id: com.discord.DiscordCanary
command: discord-canary
finish-args:
  # Subsystems shared with the host
  - --share=network
  - --share=ipc

  # Socket access
  - --socket=x11
  - --socket=wayland
  - --socket=fallback-x11
  - --socket=pulseaudio
  - --socket=system-bus

  # Device access
  - --device=dri
  - --device=input

  # Allowed FS subsets
  - --filesystem=xdg-download
  - --filesystem=xdg-run/speech-dispatcher

  # Environment variables
  - --env=ELECTRON_TRASH=gio
  - --env=XDG_CURRENT_SESSION=KDE
  - --env=XCURSOR_PATH=/run/host/user-share/icons:/run/host/share/icons

  # Bus
  - --own-name=org.kde.*
  - --talk-name=org.freedesktop.Flatpak
  - --talk-name=org.freedesktop.ScreenSaver
  - --talk-name=org.freedesktop.Notifications
  - --talk-name=org.kde.StatusNotifierWatcher
  - --talk-name=com.canonical.AppMenu.Registrar
  - --talk-name=com.canonical.indicator.application
  - --talk-name=com.canonical.Unity
modules:
  - name: font
    buildsystem: simple
    build-commands:
      - install -Dm 644 Twemoji.ttf -t /app/share/fonts
      - install -Dm 644 font.conf /app/etc/fonts/local.conf
      - fc-cache -fv
    sources:
      - type: dir
        path: src

  - name: app
    buildsystem: simple
    build-commands:
      - install -Dm 755 -t ${FLATPAK_DEST}/bin discord-canary
      - install -Dm 755 -t ${FLATPAK_DEST}/bin disable-breaking-updates.py

      # DO NOT EDIT
      - install -Dm 755 apply_extra ${FLATPAK_DEST}/bin/apply_extra
      - install -Dm 644 -t ${FLATPAK_DEST}/share/metainfo ${FLATPAK_ID}.metainfo.xml
      - install -Dm 644 -t ${FLATPAK_DEST}/share/applications ${FLATPAK_ID}.desktop
      - install -Dm 644 -t ${FLATPAK_DEST}/share/icons/hicolor/256x256/apps ${FLATPAK_ID}.png
    sources:
      - type: file
        path: com.discord.DiscordCanary.metainfo.xml

      - commands:
          - mkdir discord/
          - tar -xzf source.tar.gz --directory=discord/ --strip-components=1
          - rm source.tar.gz

        # DO NOT EDIT
        dest-filename: apply_extra
        type: script

      - x-checker-data:
          type: rotating-url
          is-main-source: true
          url: https://discord.com/api/download/canary?platform=linux&format=tar.gz
          pattern: https://dl.discord-canary.net/apps/linux/([0-9.]+)/discord-canary-([0-9.]+).tar.gz

        url: https://canary.dl2.discordapp.net/apps/linux/0.0.541/discord-canary-0.0.541.tar.gz
        sha256: ba94f5d82db75649be059c9c280b9f4733396078b3a5926d11a2631c6cd8b6fe
        size: 101848559

        # DO NOT EDIT
        type: extra-data
        filename: source.tar.gz

      # DO NOT EDIT
      - type: dir
        path: src

    modules:
      - name: pciutils
        disabled: true
        no-autogen: true
        make-args:
          - SHARED=yes
          - PREFIX=/app
        make-install-args:
          - SHARED=yes
          - PREFIX=/app
        sources:
          - type: archive
            url: https://github.com/pciutils/pciutils/archive/v3.13.0.tar.gz
            sha256: 861fc26151a4596f5c3cb6f97d6c75c675051fa014959e26fb871c8c932ebc67
            x-checker-data:
              type: anitya
              project-id: 2605
              url-template: https://github.com/pciutils/pciutils/archive/v$version.tar.gz

      - name: socat
        sources:
          - type: archive
            url: http://www.dest-unreach.org/socat/download/socat-1.8.0.2.tar.gz
            sha256: e9498367cb765d44bb06be9709c950f436b30bf7071a224a0fee2522f9cbb417
            x-checker-data:
              type: anitya
              project-id: 4848
              url-template: http://www.dest-unreach.org/socat/download/socat-$version.tar.gz

  - name: zypak
    sources:
      - type: git
        url: https://github.com/refi64/zypak
        tag: v2023.02beta.1
        commit: 64f6ccfdfd223cc2d2d68608ef42b8ff2fd6400e
        x-checker-data:
          type: git
          tag-pattern: ^v([\d.]+(?:beta[\d.]+?))$

sdk: org.freedesktop.Sdk
tags: [proprietary]
runtime: org.freedesktop.Platform
runtime-version: '23.08'
separate-locales: false
