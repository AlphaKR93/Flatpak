id: com.beeper.Beeper
command: beeper
finish-args:
  # Subsystems shared with the host
  - --share=network
  - --share=ipc

  # Socket access
  - --socket=x11
  - --socket=wayland
  - --socket=fallback-x11
  - --socket=pulseaudio
  - --socket=system-bus

  # Device access
  - --device=dri

  # Allowed FS subsets
  - --filesystem=xdg-download

  # Environment variables
  - --env=ELECTRON_TRASH=gio
  - --env=XDG_CURRENT_SESSION=KDE
  - --env=XCURSOR_PATH=/run/host/user-share/icons:/run/host/share/icons

  # Bus
  - --own-name=org.kde.*
  - --talk-name=org.freedesktop.Flatpak
  - --talk-name=org.freedesktop.ScreenSaver
  - --talk-name=org.freedesktop.Notifications
  - --talk-name=org.kde.StatusNotifierWatcher
  - --talk-name=com.canonical.AppMenu.Registrar
  - --talk-name=com.canonical.indicator.application
  - --talk-name=com.canonical.Unity
modules:
  - name: font
    buildsystem: simple
    build-commands:
      - install -Dm 644 Twemoji.ttf -t /app/share/fonts
      - install -Dm 644 font.conf /app/etc/fonts/local.conf
      - fc-cache -fv
    sources:
      - type: dir
        path: src

  - name: app
    buildsystem: simple
    build-commands:
      - install -Dm 755 -t ${FLATPAK_DEST}/bin beeper

      # DO NOT EDIT
      - install -Dm 755 apply_extra ${FLATPAK_DEST}/bin/apply_extra
      - install -Dm 644 -t ${FLATPAK_DEST}/share/metainfo ${FLATPAK_ID}.metainfo.xml
      - install -Dm 644 -t ${FLATPAK_DEST}/share/applications ${FLATPAK_ID}.desktop
      - install -Dm 644 -t ${FLATPAK_DEST}/share/icons/hicolor/256x256/apps ${FLATPAK_ID}.png
    sources:
      - type: file
        path: com.beeper.Beeper.metainfo.xml

      - commands:
          - bsdtar -Oxf source.deb data.tar.xz | bsdtar -xf - --strip-components=3
            ./opt/Beeper
          - rm source.deb

        # DO NOT EDIT
        dest-filename: apply_extra
        type: script

      - url: https://download.todesktop.com/2003241lzgn20jd/beeper-3.109.1-build-240923466rji1i4-amd64.deb
        sha256: c74df62555372532911ef7fa8abe166ad6fd086efad7269193d419f97efd0e0a
        size: 123803512
        x-checker-data:
          type: json
          is-main-source: true
          url: https://api.alpha93.kr/tools/io/conv/json?url=https://download.todesktop.com/2003241lzgn20jd/latest-linux.yml
          version-query: .version
          timestamp-query: .releaseDate
          url-query: .files | .[] | select(.url | contains("deb")) | "https://download.todesktop.com/2003241lzgn20jd/"
            + .url

        # DO NOT EDIT
        type: extra-data
        filename: source.deb

      # DO NOT EDIT
      - type: dir
        path: src

    modules:
      - name: pciutils
        disabled: true
        no-autogen: true
        make-args:
          - SHARED=yes
          - PREFIX=/app
        make-install-args:
          - SHARED=yes
          - PREFIX=/app
        sources:
          - type: archive
            url: https://github.com/pciutils/pciutils/archive/v3.13.0.tar.gz
            sha256: 861fc26151a4596f5c3cb6f97d6c75c675051fa014959e26fb871c8c932ebc67
            x-checker-data:
              type: anitya
              project-id: 2605
              url-template: https://github.com/pciutils/pciutils/archive/v$version.tar.gz

      - name: socat
        sources:
          - type: archive
            url: http://www.dest-unreach.org/socat/download/socat-1.8.0.1.tar.gz
            sha256: dc350411e03da657269e529c4d49fe23ba7b4610b0b225c020df4cf9b46e6982
            x-checker-data:
              type: anitya
              project-id: 4848
              url-template: http://www.dest-unreach.org/socat/download/socat-$version.tar.gz

  - name: zypak
    sources:
      - type: git
        url: https://github.com/refi64/zypak
        tag: v2023.02beta.1
        commit: 64f6ccfdfd223cc2d2d68608ef42b8ff2fd6400e
        x-checker-data:
          type: git
          tag-pattern: ^v([\d.]+(?:beta[\d.]+?))$

sdk: org.freedesktop.Sdk
tags: [proprietary]
runtime: org.freedesktop.Platform
runtime-version: '23.08'
separate-locales: false
